#! /bin/sh

set -e

build() {
    NAME=$1
    shift
    BUILD=b.${NAME}
    cmake -G Ninja -B ${BUILD} $@
    cmake --build ${BUILD} --target iwasm
    cp ${BUILD}/iwasm ~/bin/iwasm.${NAME}
}

COMMON="-DWAMR_BUILD_BULK_MEMORY=1"
# COMMON="${COMMON} -DWAMR_BUILD_SHARED_MEMORY=1"
COMMON="${COMMON} -DWAMR_BUILD_SIMD=1"
COMMON="${COMMON} -DWAMR_BUILD_REF_TYPES=1"
COMMON="${COMMON} -DWAMR_BUILD_LIBC_BUILTIN=0"
COMMON="${COMMON} -DWAMR_BUILD_LIBC_WASI=1"

# -DWAMR_DISABLE_HW_BOUND_CHECK=1
# -DWAMR_DISABLE_STACK_HW_BOUND_CHECK=1

LLVM_DIR=/usr/local/opt/llvm@14/lib/cmake/llvm

build classic ${COMMON} \
-DWAMR_BUILD_FAST_INTERP=0 \
-DWAMR_BUILD_AOT=0 \
.

build fast ${COMMON} \
-DWAMR_BUILD_FAST_INTERP=1 \
-DWAMR_BUILD_AOT=0 \
.

build fast-jit ${COMMON} \
-DWAMR_BUILD_FAST_JIT=1 \
-DWAMR_BUILD_LAZY_JIT=1 \
-DWAMR_BUILD_AOT=0 \
.

build fast-jit-nolazy ${COMMON} \
-DWAMR_BUILD_FAST_JIT=1 \
-DWAMR_BUILD_LAZY_JIT=0 \
-DWAMR_BUILD_AOT=0 \
.

build llvm-jit ${COMMON} \
-DWAMR_BUILD_FAST_JIT=0 \
-DWAMR_BUILD_JIT=1 \
-DWAMR_BUILD_LAZY_JIT=1 \
-DWAMR_BUILD_AOT=0 \
-DLLVM_DIR=${LLVM_DIR} \
.

build jit-tierup ${COMMON} \
-DWAMR_BUILD_FAST_JIT=1 \
-DWAMR_BUILD_JIT=1 \
-DWAMR_BUILD_LAZY_JIT=1 \
-DWAMR_BUILD_AOT=0 \
-DLLVM_DIR=${LLVM_DIR} \
.

build aot ${COMMON} \
-DWAMR_BUILD_INTERP=0 \
-DWAMR_BUILD_FAST_INTERP=0 \
-DWAMR_BUILD_AOT=1 \
.
